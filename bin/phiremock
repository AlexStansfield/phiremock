#!/usr/bin/php
<?php

if (PHP_SAPI != 'cli') {
    throw new \Exception('This is a standalone CLI application');
}

if (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    $loader = require __DIR__ . '/../vendor/autoload.php';
} else {
    $loader = require __DIR__ . '/../../../autoload.php';
}

use Doctrine\Common\Annotations\AnnotationRegistry;
use Mcustiel\Phiremock\Server\Http\Implementation\ReactPhpServer;
use Mcustiel\Phiremock\Server\Config\Dependencies;
use Mcustiel\DependencyInjection\DependencyInjectionService;

AnnotationRegistry::registerLoader(array($loader, 'loadClass'));
$options = CommandLine::parseArgs($argv);

$port = isset($options['port']) ? $options['port'] : (isset($options['p']) ? $options['p'] : '8086');
$interface = isset($options['ip']) ? $options['ip'] : (isset($options['i']) ? $options['i'] : '0.0.0.0');
$debug = isset($options['d']) ? $options['d'] : false;

define('LOG_LEVEL', $debug? \Monolog\Logger::DEBUG : \Monolog\Logger::INFO);

$di = Dependencies::init();
$logger = $di->get('logger');
$logger->info('Starting Phiremock...');

$expectationsDir = isset($options['e']) 
    ? realpath($options['e']) 
    : $di->get('homePathService')->getHomePath() . DIRECTORY_SEPARATOR . '.phiremock/expectations';

$logger->debug("Phiremock's expectation dir: $expectationsDir");

if (is_dir($expectationsDir)) {
    $di->get('fileExpectationsLoader')->loadExpectationsFromDirectory($expectationsDir);
}

$server = $di->get('server');
$server->setRequestHandler($di->get('application'));

$handleTermination = function ($signal = 0) use ($server, $$logger) {
	$logger->info('Stopping Phiremock...');
    $server->shutdown();
    $logger->info('Bye bye');
};

register_shutdown_function($handleTermination);

if (function_exists('pcntl_signal')) {
	pcntl_signal(SIGTERM, $handleTermination);
	pcntl_signal(SIGABRT, $handleTermination);
}

$server->listen($port, $interface);
