#!/usr/bin/php
<?php

if (PHP_SAPI != 'cli') {
    throw new \Exception('This is a standalone CLI application');
}

if (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    $loader = require __DIR__ . '/../vendor/autoload.php';
} else {
    $loader = require __DIR__ . '/../../../autoload.php';
}

use Doctrine\Common\Annotations\AnnotationRegistry;
use Mcustiel\Phiremock\Server\Http\Implementation\ReactPhpServer;
use Mcustiel\Phiremock\Server\Config\Dependencies;
use Mcustiel\DependencyInjection\DependencyInjectionService;

AnnotationRegistry::registerLoader(array($loader, 'loadClass'));
$options = CommandLine::parseArgs($argv);

$port = isset($options['port']) ? $options['port'] : (isset($options['p']) ? $options['p'] : '8086');
$interface = isset($options['ip']) ? $options['ip'] : (isset($options['i']) ? $options['i'] : '0.0.0.0');

$di = Dependencies::init();
$server = $di->get('server');

register_shutdown_function(function () use ($server) {
    $server->shutdown();
});

$server->listen($port, $interface);
